# ðŸš€ **TY-302 ì¡°ëª… ì œì–´ ì‹œìŠ¤í…œ + LoRa í†µì‹ **

## ðŸ“‹ **í”„ë¡œì íŠ¸ ì„¤ëª…**
**PIR ì„¼ì„œ**ì™€ **CDS ì„¼ì„œ**ë¥¼ ì‚¬ìš©í•˜ì—¬ **TY-302 ë°©ìˆ˜ë“±**ì„ ì œì–´í•˜ëŠ” ì‹œìŠ¤í…œ 
ì¡°ëª… ìƒíƒœì™€ ì„¼ì„œ ë°ì´í„°ë¥¼ **UART**ë¥¼ í†µí•´ ì¶œë ¥í•˜ê³ , **LoRa í†µì‹ **ì„ í†µí•´ ì›ê²©ìœ¼ë¡œ ìƒíƒœë¥¼ ì „ì†¡(ë¯¸ì™„ì„±)

---

## âš™ï¸ **ê¸°ìˆ  ìŠ¤íƒ**
- **MCU:** STM32L452RET6  
- **LoRa ëª¨ë“ˆ:** EBYTE E22T900T22S  
- **ì¡°ëª…:** TY-302 ë°©ìˆ˜ë“± (220V)  
- **ì„¼ì„œ:** PIR ì„¼ì„œ, CDS ì„¼ì„œ  
- **í†µì‹ :** UART, LoRa  

---

## ðŸ“¡ **ì£¼ìš” ê¸°ëŠ¥**

### 1ï¸âƒ£ **ì„¼ì„œ ë°ì´í„° ì½ê¸°**
- **PIR ì„¼ì„œ:** ì›€ì§ìž„ ê°ì§€ ì—¬ë¶€ í™•ì¸  
- **CDS ì„¼ì„œ:** ì¡°ë„ì˜ ì•„ë‚ ë¡œê·¸ ë° ë””ì§€í„¸ ê°’ í™•ì¸  

### 2ï¸âƒ£ **ì¡°ëª… ì œì–´ ë¡œì§**
1. **ë¹›ì´ ê°•í•˜ê³  PIR ê°ì§€ê°€ ì—†ëŠ” ê²½ìš°:**  
   - PIR ì„¼ì„œê°€ ê°ì§€ë˜ì§€ ì•Šìœ¼ë©´ **5ì´ˆ í›„ ìžë™ìœ¼ë¡œ ì¡°ëª… OFF**  

2. **ë¹›ì´ ì•½í•œë° ì¡°ëª…ì´ êº¼ì§„ ê²½ìš°:**  
   - UART ë° LoRaë¡œ **ì—ëŸ¬ ë©”ì‹œì§€ ì „ì†¡**

3. **ì‹¤ì‹œê°„ ìƒíƒœ ì¶œë ¥:**  
   - PIR ìƒíƒœ, CDS ì„¼ì„œ ê°’, ì¡°ëª… ìƒíƒœ UARTë¡œ ì¶œë ¥  

### 3ï¸âƒ£ **SSR ìƒíƒœ ëª¨ë‹ˆí„°ë§**
- SSRì´ **ìž¥ì‹œê°„ ON ìƒíƒœì¼ ê²½ìš°** UARTë¥¼ í†µí•´ ê²½ê³  ë©”ì‹œì§€ ì¶œë ¥  

### 4ï¸âƒ£ **LoRa ë°ì´í„° ì „ì†¡**
- ì‹œìŠ¤í…œ ìƒíƒœ ë° ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ **LoRaë¥¼ í†µí•´ ì›ê²© ì „ì†¡**  

---

## ðŸ› ï¸ **í•˜ë“œì›¨ì–´ í•€ ì„¤ì •**

### ðŸ“Œ **GPIO ì„¤ì •**

| **ê¸°ëŠ¥**       | **í•€ ë²ˆí˜¸** | **ì„¤ëª…**           |
|-----------------|------------|--------------------|
| **PIR ì„¼ì„œ**   | PC6        | ì›€ì§ìž„ ê°ì§€        |
| **CDS ì„¼ì„œ**   | PC7        | ì¡°ë„ ë””ì§€í„¸ ì‹ í˜¸   |
| **CDS ì•„ë‚ ë¡œê·¸** | PB0        | ì¡°ë„ ì•„ë‚ ë¡œê·¸ ê°’   |
| **SSR ì œì–´**   | PB2        | ì¡°ëª… ON/OFF ì œì–´   |
| **LoRa M0**    | PB11       | LoRa ëª¨ë“œ í•€       |
| **LoRa M1**    | PB12       | LoRa ëª¨ë“œ í•€       |
| **LoRa UART_TX** | PD8        | UART TX (LoRa ì†¡ì‹ ) |
| **LoRa UART_RX** | PD9        | UART RX (LoRa ìˆ˜ì‹ ) |
| **GND**        | P5         | ê³µí†µ GND ì—°ê²°      |
| **12V ì „ì›**   | P5         | ì‹œìŠ¤í…œ ì „ì› ê³µê¸‰   |
| **ì¡°ëª… ì¶œë ¥**  | P2         | TY-302 ë°©ìˆ˜ë“± ì œì–´ |

### ðŸ“Œ **UART ì„¤ì •**

| **UART ì¸í„°íŽ˜ì´ìŠ¤** | **TX í•€** | **RX í•€** | **ê¸°ëŠ¥**        |
|----------------------|---------|---------|----------------|
| **USART3 (LoRa)**    | PD8     | PD9     | LoRa í†µì‹       |
| **USART1 (ë””ë²„ê¹…)**  | PA9     | PA10    | UART ë””ë²„ê¹…    |

### ðŸ“Œ **ADC ì„¤ì •**

| **ê¸°ëŠ¥**       | **í•€ ë²ˆí˜¸** | **ì„¤ëª…**        |
|-----------------|------------|---------------|
| **CDS ì„¼ì„œ**   | PB0        | ì•„ë‚ ë¡œê·¸ ìž…ë ¥  |

### ðŸ“Œ **ì „ì› ì„¤ì •**

| **ê¸°ëŠ¥**      | **í•€ ë²ˆí˜¸** | **ì„¤ëª…**    |
|---------------|------------|-----------|
| **SSR ì „ì›**  | P1         | 220V ê³µê¸‰  |
| **GND/12V**   | P5         | GND/12V   |
| **ì¡°ëª… ì¶œë ¥** | P2         | ë°©ìˆ˜ë“± ì¶œë ¥ |

---

## ðŸ”„ **ì‹œìŠ¤í…œ ë™ìž‘ íë¦„**
1. **ì„¼ì„œ ìƒíƒœ í™•ì¸**  
   - PIR ë° CDS ì„¼ì„œ ê°’ì„ ì½ê³  UARTë¡œ ì¶œë ¥  

2. **ì¡°ëª… ì œì–´**  
   - PIR ê°ì§€ ë° CDS ì¡°ë„ ê°’ì— ë”°ë¼ ì¡°ëª…ì„ ON/OFF  

3. **ì—ëŸ¬ ê°ì§€**  
   - CDS ê°’ì´ ë‚®ê³  ì¡°ëª…ì´ êº¼ì ¸ìžˆìœ¼ë©´ ì—ëŸ¬ ë©”ì‹œì§€ ì „ì†¡  

4. **SSR ìƒíƒœ ëª¨ë‹ˆí„°ë§**  
   - SSRì´ ìž¥ì‹œê°„ ONì¼ ê²½ìš° ê²½ê³  ë©”ì‹œì§€ ì „ì†¡  

5. **LoRa ì „ì†¡**  
   - ìƒíƒœ ë° ì—ëŸ¬ ë©”ì‹œì§€ LoRaë¡œ ì†¡ì‹   

---

## ðŸ“ **ì£¼ìš” ì½”ë“œ ì„¤ëª…**

### ðŸ”¹ **ì„¼ì„œ ë°ì´í„° ì½ê¸°**
```c
void Read_Sensors(void) {
    pir_state = HAL_GPIO_ReadPin(GPIOC, GPIO_PIN_6);
    cds_digital_state = HAL_GPIO_ReadPin(GPIOC, GPIO_PIN_7);

    HAL_ADC_Start(&hadc1);
    if (HAL_ADC_PollForConversion(&hadc1, HAL_MAX_DELAY) == HAL_OK) {
        cds_analog_value = HAL_ADC_GetValue(&hadc1);
    }
    HAL_ADC_Stop(&hadc1);
}
```
### ðŸ”¹ **ì¡°ëª… ì œì–´**
```c
void Control_Light(void) {
    static uint32_t light_timer = 0;

    if (cds_analog_value > CDS_LIGHT_THRESHOLD) {
        if (pir_state == GPIO_PIN_RESET) {
            if (light_timer == 0) {
                light_timer = HAL_GetTick();
            } else if ((HAL_GetTick() - light_timer) >= LIGHT_OFF_DELAY) {
                HAL_GPIO_WritePin(GPIOB, GPIO_PIN_2, GPIO_PIN_RESET);
                UART_SendString("[INFO] Light turned OFF after 5s due to no PIR detection.\r\n");
                light_timer = 0;
            }
        } else {
            HAL_GPIO_WritePin(GPIOB, GPIO_PIN_2, GPIO_PIN_SET);
            UART_SendString("[INFO] Light ON (CDS Bright + PIR Detected).\r\n");
            light_timer = 0;
        }
    } else {
        if (HAL_GPIO_ReadPin(GPIOB, GPIO_PIN_2) == GPIO_PIN_RESET) {
            UART_SendString("[ERROR] Low light detected, but light is OFF!\r\n");
            LoRa_SendData("[ERROR] Low light detected, but light is OFF!");
        }
    }
}
```
